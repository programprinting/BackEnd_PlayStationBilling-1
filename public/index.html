<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TV Controller</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f4f4f4; margin: 0; padding: 0; }
        .container { max-width: 400px; margin: 60px auto; background: #fff; padding: 32px 24px 24px 24px; border-radius: 10px; box-shadow: 0 2px 12px rgba(0,0,0,0.08); }
        h2 { text-align: center; margin-bottom: 24px; }
        label { display: block; margin-bottom: 8px; }
        input[type=text], input[type=number] { width: 100%; padding: 8px; margin-bottom: 16px; border: 1px solid #ccc; border-radius: 4px; }
        .btn-group { display: flex; justify-content: space-between; }
        button { flex: 1; padding: 12px 0; margin: 0 4px; border: none; border-radius: 4px; font-size: 16px; cursor: pointer; transition: background 0.2s; }
        .on { background: #4caf50; color: #fff; }
        .off { background: #f44336; color: #fff; }
        .result { margin-top: 20px; text-align: center; font-weight: bold; }
</style>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
    <div class="container">
        <div style="text-align:center;margin-bottom:10px;">
            <img id="tv-logo" src="https://img.icons8.com/ios-filled/100/000000/tv.png" alt="TV Logo" style="width:60px;height:60px;filter:brightness(0.3);">
            <div style="margin-top:6px;display:flex;align-items:center;justify-content:center;gap:8px;">
                <span id="tv-status-indicator" style="display:inline-block;width:14px;height:14px;border-radius:50%;background:#222;vertical-align:middle;"></span>
                <span id="tv-status-text" style="font-weight:bold;vertical-align:middle;">Status: Tidak diketahui</span>
                <button id="check-tv-status-btn" style="background:#2196f3;color:#fff;padding:4px 12px;border:none;border-radius:4px;font-size:13px;cursor:pointer;margin-left:8px;">Cek Status TV</button>
            </div>
        </div>
        <h2>TV Controller</h2>
       <label>IP Address</label>
       <input type="text" id="ip" placeholder="192.168.200.226" value="192.168.200.226" style="margin-bottom: 16px;">
        <label>Port</label>
        <input type="number" id="port" placeholder="5555" value="5555">
        <label>Method</label>
        <select id="method">
            <option value="adb">ADB</option>
            <option value="tv_server">TV Server</option>
        </select>
        <div class="card" style="background:#f9f9f9;padding:18px 14px 14px 14px;border-radius:8px;box-shadow:0 1px 6px rgba(0,0,0,0.07);margin-bottom:18px;">
            <h3 style="text-align:center;margin:0 0 12px 0;font-size:20px;color:#333;">Kontrol TV</h3>
            <div class="btn-group" style="margin-bottom:10px;">
                <button class="on" style="background:#4caf50;color:#fff;box-shadow:0 2px 6px rgba(76,175,80,0.12);font-size:18px;" onclick="sendAction('power', true)">Power</button>
            </div>
            <div class="result" id="result"></div>
        </div>
        <div class="card" style="background:#f9f9f9;padding:18px 14px 14px 14px;border-radius:8px;box-shadow:0 1px 6px rgba(0,0,0,0.07);">
            <h3 style="text-align:center;margin:0 0 12px 0;font-size:20px;color:#333;">Timer (Countdown)</h3>
            <div class="timer-group" style="justify-content:center;align-items:center;gap:10px;margin-bottom:12px;">
                <input type="number" id="timer-min" min="0" max="99" placeholder="mm" value="00" style="width:60px;text-align:center;font-size:18px;"> :
                <input type="number" id="timer-sec" min="0" max="59" placeholder="ss" value="00" style="width:60px;text-align:center;font-size:18px;">
                <button onclick="startTimer()" style="background:#2196f3;color:#fff;width:80px;font-size:16px;">Start</button>
                <button onclick="stopTimer()" style="background:#bbb;color:#fff;width:80px;font-size:16px;">Stop</button>
            </div>
            <div class="countdown" id="countdown" style="text-align:center;font-size:28px;margin-bottom:8px;font-weight:bold;color:#2196f3;">00:00</div>
        </div>

    </div>
    <script>
        let timerInterval = null;
        let remaining = 0;
        function pad(n) { return n.toString().padStart(2, '0'); }
        function updateCountdown() {
            const min = Math.floor(remaining / 60);
            const sec = remaining % 60;
            document.getElementById('countdown').innerText = pad(min) + ':' + pad(sec);
        }
        function startTimer() {
            const min = parseInt(document.getElementById('timer-min').value) || 0;
            const sec = parseInt(document.getElementById('timer-sec').value) || 0;
            remaining = min * 60 + sec;
            if (remaining <= 0) return;
            updateCountdown();
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                remaining--;
                updateCountdown();
                if (remaining <= 0) {
                    clearInterval(timerInterval);
                    sendAction('power', true); // langsung jalankan tanpa konfirmasi
                }
            }, 1000);
        }
        function stopTimer() {
            if (timerInterval) clearInterval(timerInterval);
            document.getElementById('countdown').innerText = '00:00';
        }


        function sendAction(action, skipConfirm) {
            const ip = document.getElementById('ip').value;
            const port = document.getElementById('port').value;
            const method = document.getElementById('method').value;
            if (!ip || !port) {
                document.getElementById('result').innerText = 'IP dan port harus diisi!';
                return;
            }
            if (skipConfirm === true) {
                fetch(`/tv/${ip}/power?port=${port}&method=${method}`)
                    .then(res => res.json())
                    .then(data => {
                        document.getElementById('result').innerText = JSON.stringify(data);
                    })
                    .catch(err => {
                        document.getElementById('result').innerText = 'Error: ' + err;
                    });
                return;
            }
            // Hanya tampilkan konfirmasi jika skipConfirm tidak true (manual klik)
            Swal.fire({
                title: 'Konfirmasi',
                text: 'Yakin ingin menekan tombol Power TV?',
                icon: 'question',
                showCancelButton: true,
                confirmButtonText: 'Ya',
                cancelButtonText: 'Batal'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`/tv/${ip}/power?port=${port}&method=${method}`)
                        .then(res => res.json())
                        .then(data => {
                            document.getElementById('result').innerText = JSON.stringify(data);
                        })
                        .catch(err => {
                            document.getElementById('result').innerText = 'Error: ' + err;
                        });
                }
            });
        }
    </script>
    <script>
        function updateTvStatusIndicator(status) {
            const indicator = document.getElementById('tv-status-indicator');
            const text = document.getElementById('tv-status-text');
            const logo = document.getElementById('tv-logo');
            if (status === 'on') {
                indicator.style.background = '#4caf50';
                text.textContent = 'Status: Hidup';
                logo.style.filter = 'none';
            } else if (status === 'off') {
                indicator.style.background = '#222';
                text.textContent = 'Status: Mati';
                logo.style.filter = 'brightness(0.3)';
            } else {
                indicator.style.background = '#aaa';
                text.textContent = 'Status: Tidak diketahui';
                logo.style.filter = 'brightness(0.3)';
            }
        }

        function checkTvStatus() {
            const ip = document.getElementById('ip').value;
            const port = document.getElementById('port').value;
            const method = document.getElementById('method').value;
            if (!ip || !port) {
                updateTvStatusIndicator('unknown');
                return;
            }
            fetch(`/tv-status/${ip}?port=${port}&method=${method}`)
                .then(res => res.json())
                .then(data => {
                    if (data && data.status) {
                        updateTvStatusIndicator(data.status);
                    } else {
                        updateTvStatusIndicator('unknown');
                    }
                })
                .catch(() => {
                    updateTvStatusIndicator('unknown');
                });
        }

        // Cek status TV saat halaman dibuka
        window.addEventListener('DOMContentLoaded', checkTvStatus);

        // Cek status TV setiap kali IP/port/method diubah
        document.getElementById('ip').addEventListener('change', checkTvStatus);
        document.getElementById('port').addEventListener('change', checkTvStatus);
        document.getElementById('method').addEventListener('change', checkTvStatus);

        // Tombol cek status TV manual
        document.getElementById('check-tv-status-btn').onclick = function() {
            checkTvStatus();
        };

        // Update status TV setelah aksi power
        const oldSendAction = sendAction;
        sendAction = function(action, skipConfirm) {
            oldSendAction(action, skipConfirm);
            setTimeout(checkTvStatus, 1200); // Delay sedikit agar status update
        }
    </script>
</body>
</html>
